machine:
    php:
        version: 7.0.4

dependencies:
    cache_directories:
        - ~/.composer/cache

    override:
        - composer install --dev --no-progress --no-interaction --prefer-dist
        - npm install --no-progress
        - ./node_modules/.bin/gulp

    post:
        - mkdir -p $CIRCLE_TEST_REPORTS/phpunit

test:
    pre:
        - "echo \"meetup_api_key: $MEETUP_API_KEY\nmeetup_group: $MEETUP_GROUP\" > config/parameters.yml"
    override:
        - php -S localhost:8080 -t web web/index.php:
            background: true
        - sleep 5
        - npm test

deployment:
    production:
        branch: master
        owner: AmsterdamPHP
        commands:
            - cp ~/.ssh/id_amsterdamphp.nl ~/.ssh/id_rsa
            - ./vendor/bin/dep deploy
